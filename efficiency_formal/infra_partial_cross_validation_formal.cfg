[DEFAULT]
workspace = /home/shilei/fbpmx/infra_partial_cross_validation/infra_partial_cross_validation_${date}

[project]
actions = generate, evaluate, run
datasets = infra_project_item_list_origin, infra_project_item_list_origin, infra_project_item_list, infra_project_quantity_list
evaluators = llm_predict
stages = infra_partial_cross_validation


[dataset_infra_project_item_list_origin]
class = InfraProjectItemListDataset
tenant_id = 869440119900160
project_ids = 845543671478272
reset = False

[dataset_infra_project_quantity_list_origin]
class = InfraProjectQuantityListDataset
tenant_id = 869440119900160
project_ids = 845543671478272
reset = False


[dataset_infra_project_item_list]
class = InfraProjectItemListDataset
tenant_id = 869440119900160
project_ids = 845543671478272
deduplicate_by = [name, fullPath]
reset = False

[dataset_infra_project_quantity_list]
class = InfraProjectQuantityListDataset
tenant_id = 869440119900160
project_ids = 845543671478272
deduplicate_by = [wbsItem]
reset = False


[dataset_item_list_trans]
class = MapDataset
input = infra_project_item_list
expression = exec('import re; import uuid') or {'item_id': uuid.uuid4().hex, "item_name": x["name"] if x["name"] is not None else "", "item_feature": x["fullPath"] if x["fullPath"] is not None else "", "task_type": "基建清单"}
keep_exists = True

[dataset_item_quantity_trans]
class = MapDataset
input = infra_project_quantity_list
expression = exec('import re; import uuid') or {'item_id': uuid.uuid4().hex, "item_name": "", "item_feature": x["wbsItem"] if x["wbsItem"] is not None else "", "task_type": "基建工程量"}
keep_exists = True

[dataset_item_merge]
class = MergeDataset
datasets = item_list_trans, item_quantity_trans

[model_llm_speed_infra_partial]
class = LlmErnieSpeedInfraPartialModel
item_name_key = item_name
item_feature_key = item_feature
need_fields = item_name, item_feature
re_predict = False

[model_llm_lite_infra_partial]
class = LlmErnieLiteInfraPartialModel
item_name_key = item_name
item_feature_key = item_feature
need_fields = item_name, item_feature
re_predict = False

[evaluator_llm_predict]
class = SimplePredictor
datasets = item_merge
models = llm_speed_infra_partial, llm_lite_infra_partial

[dataset_test_prediction]
class = MapDataset
input = item_merge
expression = {"大模型1分部分项": x["llm_speed_infra_partial_score"]["category"] if x["llm_speed_infra_partial_score"] is not None else "", "大模型2分部分项": x["llm_lite_infra_partial_score"]["category"] if x["llm_lite_infra_partial_score"] is not None else ""}
keep_exists = True
extra_dependencies = evaluator_llm_predict


[stage_infra_partial_cross_validation]
class = CrossValStage
dataset = test_prediction
category_names = 大模型1分部分项, 大模型2分部分项
with_labels = False
save_res_path = /home/shilei/fbpmx/infra_partial_cross_validation/infra_partial_cross_validation_${date}/infra_partial_cross_validation.xlsx
keep_fields = item_id, task_type, id, tenantId, projectId, name, fullPath, wbsItem
consistency_sample_rate = 0.2
