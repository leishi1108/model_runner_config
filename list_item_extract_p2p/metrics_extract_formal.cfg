[DEFAULT]
workspace = /home/shilei/fbpmx/list_extract/metrics_extract_formal_${date}

[project]
actions = generate
datasets = metrics_test_data_leaf, metrics_data_leaf_valid


[dataset_raw_metrics_leaf]
class = ReadExcelDataset
dir = /home/shilei/corpus/metrics_subject/indicator_subject_leaf.xlsx
header_row = 0


[dataset_metrics_leaf]
class = MapDataset
input = raw_metrics_leaf
expression = exec('import re; import uuid') or {"leaf_key": x["工程ID"]+"-"+str(x["指标科目ID"])}
keep_exists = True


[dataset_raw_metrics_data]
class = ReadExcelDataset
dir = /home/shilei/corpus/metrics_subject/项目7801-成本科目-土建-解析结果(指标成本科目).xlsx,/home/shilei/corpus/metrics_subject/项目7803-成本科目-土建-解析结果(指标成本科目).xlsx,/home/shilei/corpus/metrics_subject/项目7805-成本科目-土建-解析结果(指标成本科目).xlsx,/home/shilei/corpus/metrics_subject/项目7807-成本科目-土建-解析结果(指标成本科目).xlsx
header_row = 1

[dataset_metrics_data_expected]
class = FilterDataset
input = raw_metrics_data
filters = "uid.2" in x and x["uid.2"] is not None

[dataset_metrics_data]
class = MapDataset
input = metrics_data_expected
expression = exec('import re; import uuid') or {"item_id": uuid.uuid4().hex,
    "item_name": x["科目名称"],
    "upper_item_name": x["全路径"][:len(x["全路径"])-len(x["科目名称"])].rstrip("/-#") if x["全路径"] is not None and x["全路径"].endswith(x["科目名称"]) else x["全路径"],
    "full_item_name": x["全路径"],
    "project_id": str(x["filepath"]).split("/")[-1].split("-解析结果")[0],
    "uid": x["uid"],
    "leaf_key": str(x["filepath"]).split("/")[-1].split("-解析结果")[0]+"-"+str(x["uid"]),
    "element_label": list(sorted(x["构件.1"].split(","))) if x["构件.1"] is not None else ["无构件"],
    "material_label": list(sorted(x["材料.1"].split(","))) if x["材料.1"] is not None else ["无材料"],
    }
keep_exists = True


[dataset_metrics_data_leaf]
class = MergeIntoDataset
base_dataset = metrics_data
merge_datasets = metrics_leaf
merge_type = only_replace
merge_key = leaf_key
merge_values = 是否叶子结点
reset = False

[dataset_metrics_data_leaf_valid]
class = FilterDataset
input = metrics_data_leaf
filters = x["是否叶子结点"] == "是"


[dataset_raw_metrics_test_data]
class = ReadExcelDataset
dir = /home/shilei/corpus/metrics_subject/湖南省房屋建筑工程指标指数测算标准-解析结果(指标成本科目).xlsx,/home/shilei/corpus/metrics_subject/海南省建设工程造价指标指数编制指南-解析结果(指标成本科目).xlsx,/home/shilei/corpus/metrics_subject/山东建设工程造价指标采集与发布标准-解析结果(指标成本科目).xlsx,/home/shilei/corpus/metrics_subject/湖北省建筑工程和市政工程造价数据归集标准-解析结果(指标成本科目).xlsx
header_row = 1

[dataset_metrics_test_keydata]
class = MapDataset
input = raw_metrics_test_data
expression = exec('import re; import uuid') or {"item_id": uuid.uuid4().hex,
    "item_name": x["科目名称"],
    "upper_item_name": x["全路径"],
    "full_item_name": "/".join(map(str, [a for a in [x["全路径"], x["科目名称"]] if a is not None])) ,
    "project_id": str(x["filepath"]).split("/")[-1].split("-解析结果")[0],
    "uid": x["uid"],
    "leaf_key": str(x["filepath"]).split("/")[-1].split("-解析结果")[0]+"-"+str(x["uid"]),
    "element_label": list(sorted(x["构件.1"].split(","))) if x["构件.1"] is not None else "无构件",
    "material_label": list(sorted(x["材料.1"].split(","))) if x["材料.1"] is not None else "无材料"
    }
keep_exists = True

[stage_layer_relation_export]
class = LayerRelationStage
dataset = metrics_test_keydata
name_id_key = item_id
name_key = item_name
full_name_key = full_item_name
full_name_delimiter = /
project_id_key = project_id
save_json_path = /home/shilei/fbpmx/list_extract/metrics_extract_formal_${date}/layer_relation_export.json

[dataset_layer_relation]
class = ReadFileDataset
format = json
dir = /home/shilei/fbpmx/list_extract/metrics_extract_formal_${date}/layer_relation_export.json
extra_dependencies = stage_layer_relation_export

[dataset_metrics_test_data_relation]
class = MergeIntoDataset
base_dataset = metrics_test_keydata
merge_datasets = layer_relation
merge_type = only_replace
merge_key = item_id
merge_values = parent_name, parent_id, child_name, child_id


[dataset_metrics_test_data_leaf]
class = FilterDataset
input = metrics_test_data_relation
filters = "uid.2" in x and x["uid.2"] is not None and "child_id" in x and isinstance(x["child_id"], list) and len(x["child_id"]) <= 0 and x["专业.1"] in ["土建专业", "装修专业"]
