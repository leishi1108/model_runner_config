[DEFAULT]
workspace = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}

[project]
actions = generate, evaluate, run
datasets = raw_formal_data, formal_data_mergeAll, formal_data_test_fixed_label, formal_data_train_fixed_label, custom_data_mergeAll, custom_data_mergeAll_fixed_label, history60w_data_sample_element_data_trans, history60w_train_merge
evaluators = GTJ_formal_element_extract_fixed_evaluate, GTJ_custom_element_extract_evaluate, GTJ_formal_history_element_extract_model_evaluate
stages = GTJ_custom_data_evaluate, train_data_export, history60w_test_data_export, history60w_train_data_export_1, history60w_train_data_export_2, history60w_train_data_export_3

############ GTJ 正式环境数据 ############

[dataset_raw_formal_data]
class = ReadFileDataset
format = json
dir = /home/shilei/corpus/cost_split/GTJ_formal_data_expected_data.json

[dataset_formal_data]
class = MapDataset
input = raw_formal_data
expression = exec('import re; import uuid') or {"project_code": uuid.uuid3(uuid.NAMESPACE_DNS, str(x["filepath"]).split("/")[-1].split("-解析预期结果")[0]).hex, "project_id": str(x["filepath"]).split("/")[-1].split("-解析预期结果")[0], "list_key": str(x["filepath"]).split("/")[-1].split("-解析预期结果")[0] + "-" + str(x["ID"])}
keep_exists = True

[dataset_formal_data_feature]
class = MapDataset
input = formal_data
expression = {"project_id": x["project_id"], "project_code": x["project_code"], "list_key": x["list_key"], "ID": x["ID"],
              "filepath": x["filepath"], "单位工程名称": x["单位工程名称"], "全路径": x["全路径"], "清单编码": x["清单编码"],
              "清单名称": x["清单名称"], "清单特征": x["清单特征"], "单位": x["单位"],
              "item_name": x["清单名称"] if x["清单名称"] is not None else "",
              "item_feature": x["清单特征"] if x["清单特征"] is not None else "",
              "upper_item_name": x["全路径"] if x["全路径"] is not None else "",
              "project_name": x["单位工程名称"] if x["单位工程名称"] is not None else "",
              "item_name_wk": f'清单名称: {x["清单名称"]}' if x["清单名称"] is not None else "",
              "item_feature_wk": f'清单特征: {x["清单特征"]}' if x["清单特征"] is not None else "",
              "upper_item_name_wk": f'全路径: {x["全路径"]}' if x["全路径"] is not None else "",
              }

[dataset_formal_data_feature_dedup]
class = AccumulateDataset
input = formal_data_feature
deduplicate_by = list_key


[dataset_formal_partial]    ## GTJ 不解析分部分项
class = MapDataset
input = formal_data
expression = {"list_key": x["list_key"], "成本分部分项": x["成本分部分项"]}

[dataset_formal_partial_grouped]
class = GroupedDataset
input = formal_partial
groupby = list_key
value_key = 成本分部分项


[dataset_formal_element]
class = MapDataset
input = formal_data
expression = {"list_key": x["list_key"], "构件": x["构件"]}

[dataset_formal_element_grouped]
class = GroupedDataset
input = formal_element
groupby = list_key
value_key = 构件

[dataset_formal_material]
class = MapDataset
input = formal_data
expression = {"list_key": x["list_key"], "材料": x["材料"]}

[dataset_formal_material_grouped]
class = GroupedDataset
input = formal_material
groupby = list_key
value_key = 材料


[dataset_formal_data_mergeElement]
class = MergeIntoDataset
base_dataset = formal_data_feature_dedup
merge_datasets = formal_element_grouped
merge_type = only_replace
merge_key = list_key
merge_values = 构件
reset = False

[dataset_formal_data_mergeMaterial]
class = MergeIntoDataset
base_dataset = formal_data_mergeElement
merge_datasets = formal_material_grouped
merge_type = only_replace
merge_key = list_key
merge_values = 材料
reset = False


[dataset_formal_data_mergeAll]
class = MergeIntoDataset
base_dataset = formal_data_mergeMaterial
merge_datasets = formal_partial_grouped
merge_type = only_replace
merge_key = list_key
merge_values = 成本分部分项
reset = False

####### GTJ 正式环境数据 fixed ########

[dataset_raw_formal_fixed_data]
class = ReadExcelDataset
dir = /home/shilei/corpus/cost_split/formal_data_train_data_evaluate_20241101.xlsx, /home/shilei/corpus/cost_split/GTJ_formal_data_test_label_export_20241101.xlsx
sheet_names = pred_data
header_row = 0

[dataset_raw_formal_element_fixed_data]
class = FilterDataset
input = raw_formal_fixed_data
filters = "构件预期修改" in x and x["构件预期修改"] is not None

[dataset_formal_element_fixed_data]
class = MapDataset
input = raw_formal_element_fixed_data
expression = {"list_key": str(x["清单id"]), "构件": "" if x["构件预期修改"] == "无构件" else x["构件预期修改"]}

[dataset_raw_formal_material_fixed_data]
class = FilterDataset
input = raw_formal_fixed_data
filters = "材料预期修改" in x and x["材料预期修改"] is not None

[dataset_formal_material_fixed_data]
class = MapDataset
input = raw_formal_material_fixed_data
expression = {"list_key": str(x["清单id"]), "材料": "" if x["材料预期修改"] == "无材料" else x["材料预期修改"]}


[dataset_formal_data_mergeAll_fixed]
class = MergeIntoDataset
base_dataset = formal_data_mergeAll
merge_datasets = formal_element_fixed_data
merge_type = only_replace
merge_key = list_key
merge_values = 构件
reset = False

[dataset_formal_data_test_fixed]
class = FilterDataset
input = formal_data_mergeAll_fixed
filters = ("project_code" in x) and ( int(x["project_code"][-5:],16) % 10 < 2 )

[dataset_formal_data_train_fixed]
class = FilterDataset
input = formal_data_mergeAll_fixed
filters = ("project_code" in x) and ( int(x["project_code"][-5:],16) % 10 >= 2 )

[dataset_formal_data_test_fixed_label]
class = MapDataset
input = formal_data_test_fixed
expression = {
    "upper_item_name_dropout": x["upper_item_name_wk"],
    "element_label": list(sorted(x["构件"].split(","))) if x["构件"] is not None else [],
    "material_label": list(sorted(x["材料"].split(","))) if x["材料"] is not None else []
    }
keep_exists = True

[dataset_formal_data_train_fixed_label]
class = MapDataset
input = formal_data_train_fixed
expression = {
    "upper_item_name_dropout": x["upper_item_name_wk"] if random.random()<0.5 else "",
    "element_label": list(sorted(x["构件"].split(","))) if x["构件"] is not None else [],
    "material_label": list(sorted(x["材料"].split(","))) if x["材料"] is not None else []
    }
keep_exists = True

################################################################################

[model_GTJ_formal_extract_model_fixed]
class = MultiHeadMultiLabelClassificationModel
data = formal_data_train_fixed_label
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 2.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True

[model_GTJ_formal_extract_model_fixed2]
class = MultiHeadMultiLabelClassificationModel
data = formal_data_train_fixed_label
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 2.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True

[model_GTJ_formal_extract_model_fixed3]
class = MultiHeadMultiLabelClassificationModel
data = formal_data_train_fixed_label
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 1.0e-4
num_epochs = 200
train_ratio = 0.85
batch_size = 256
max_seq_length = 128
re_predict = True


[model_GTJ_formal_extract_model_fixed4]
class = MultiHeadMultiLabelClassificationModel
data = formal_data_train_fixed_label
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 1.0e-4
num_epochs = 200
train_ratio = 0.85
batch_size = 256
max_seq_length = 128
re_predict = True


[model_GTJ_formal_extract_model_fixed5]
class = MultiHeadMultiLabelClassificationModel
data = formal_data_train_fixed_label
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 5.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True

[model_GTJ_formal_extract_model_fixed6]
class = MultiHeadMultiLabelClassificationModel
data = formal_data_train_fixed_label
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 5.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True

[model_GTJ_formal_extract_model_fixed7]
class = MultiHeadMultiLabelClassificationModel
data = formal_data_train_fixed_label
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 5.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True


[model_GTJ_formal_extract_model_fixed8]
class = MultiHeadMultiLabelClassificationModel
data = formal_data_train_fixed_label
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 5.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True


[model_GTJ_formal_element_extract_model_fixed]
class = CalculateModel
models = GTJ_formal_extract_model_fixed
expression = GTJ_formal_extract_model_fixed["构件"]
re_predict = True

[model_GTJ_formal_material_extract_model_fixed]
class = CalculateModel
models = GTJ_formal_extract_model_fixed
expression = GTJ_formal_extract_model_fixed["材料"]
re_predict = True

[model_GTJ_formal_element_extract_model_fixed2]
class = CalculateModel
models = GTJ_formal_extract_model_fixed2
expression = GTJ_formal_extract_model_fixed2["构件"]
re_predict = True

[model_GTJ_formal_material_extract_model_fixed2]
class = CalculateModel
models = GTJ_formal_extract_model_fixed2
expression = GTJ_formal_extract_model_fixed2["材料"]
re_predict = True

[model_GTJ_formal_element_extract_model_fixed3]
class = CalculateModel
models = GTJ_formal_extract_model_fixed3
expression = GTJ_formal_extract_model_fixed3["构件"]
re_predict = True

[model_GTJ_formal_material_extract_model_fixed3]
class = CalculateModel
models = GTJ_formal_extract_model_fixed3
expression = GTJ_formal_extract_model_fixed3["材料"]
re_predict = True

[model_GTJ_formal_element_extract_model_fixed4]
class = CalculateModel
models = GTJ_formal_extract_model_fixed4
expression = GTJ_formal_extract_model_fixed4["构件"]
re_predict = True

[model_GTJ_formal_material_extract_model_fixed4]
class = CalculateModel
models = GTJ_formal_extract_model_fixed4
expression = GTJ_formal_extract_model_fixed4["材料"]
re_predict = True

[model_GTJ_formal_element_extract_model_fixed5]
class = CalculateModel
models = GTJ_formal_extract_model_fixed5
expression = GTJ_formal_extract_model_fixed5["构件"]
re_predict = True

[model_GTJ_formal_material_extract_model_fixed5]
class = CalculateModel
models = GTJ_formal_extract_model_fixed5
expression = GTJ_formal_extract_model_fixed5["材料"]
re_predict = True

[model_GTJ_formal_element_extract_model_fixed6]
class = CalculateModel
models = GTJ_formal_extract_model_fixed6
expression = GTJ_formal_extract_model_fixed6["构件"]
re_predict = True

[model_GTJ_formal_material_extract_model_fixed6]
class = CalculateModel
models = GTJ_formal_extract_model_fixed6
expression = GTJ_formal_extract_model_fixed6["材料"]
re_predict = True

[model_GTJ_formal_element_extract_model_fixed7]
class = CalculateModel
models = GTJ_formal_extract_model_fixed7
expression = GTJ_formal_extract_model_fixed7["构件"]
re_predict = True

[model_GTJ_formal_material_extract_model_fixed7]
class = CalculateModel
models = GTJ_formal_extract_model_fixed7
expression = GTJ_formal_extract_model_fixed7["材料"]
re_predict = True

[model_GTJ_formal_element_extract_model_fixed8]
class = CalculateModel
models = GTJ_formal_extract_model_fixed8
expression = GTJ_formal_extract_model_fixed8["构件"]
re_predict = True

[model_GTJ_formal_material_extract_model_fixed8]
class = CalculateModel
models = GTJ_formal_extract_model_fixed8
expression = GTJ_formal_extract_model_fixed8["材料"]
re_predict = True

[evaluator_GTJ_formal_element_extract_fixed_evaluate]
class=MultiLabelClassificationTBEvaluator
dataset = formal_data_test_fixed_label
models = GTJ_formal_element_extract_model_fixed, GTJ_formal_element_extract_model_fixed2,GTJ_formal_element_extract_model_fixed3, GTJ_formal_element_extract_model_fixed4,GTJ_formal_element_extract_model_fixed5,GTJ_formal_element_extract_model_fixed6, GTJ_formal_element_extract_model_fixed7, GTJ_formal_element_extract_model_fixed8
categories = 地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙
categories_delimeter = |
label_key = element_label
save_res_path = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}/GTJ_formal_element_extract_fixed_evaluate.xlsx


############ 构件/材料 评估 ############

[model_tjqd2]
class = GDETJQD2ServiceModel
task_type = 清单
item_name_key = item_name
item_feature_key = item_feature
upper_item_name_key = upper_item_name
project_name_key = project_name
need_fields = item_name,item_feature,upper_item_name,project_name


############ GTJ 客户反馈标注数据 ############

[dataset_raw_custom_data]
class = ReadFileDataset
format = json
dir = /home/shilei/corpus/cost_split/GTJ_custom_data_expected_data.json

[dataset_custom_data]
class = MapDataset
input = raw_custom_data
expression = exec('import re; import uuid') or {"project_code": uuid.uuid3(uuid.NAMESPACE_DNS, str(x["filepath"]).split("/")[-1].split("-解析预期结果")[0]).hex, "project_id": str(x["filepath"]).split("/")[-1].split("-解析预期结果")[0], "list_key": str(x["filepath"]).split("/")[-1].split("-解析预期结果")[0] + "-" + str(x["ID"])}
keep_exists = True


[dataset_custom_data_feature]
class = MapDataset
input = custom_data
expression = {"project_id": x["project_id"], "project_code": x["project_code"], "list_key": x["list_key"], "ID": x["ID"],
              "filepath": x["filepath"], "单位工程名称": x["单位工程名称"], "全路径": x["全路径"], "清单编码": x["清单编码"],
              "清单名称": x["清单名称"], "清单特征": x["清单特征"], "单位": x["单位"],
              "item_name": x["清单名称"] if x["清单名称"] is not None else "",
              "item_feature": x["清单特征"] if x["清单特征"] is not None else "",
              "upper_item_name": x["全路径"] if x["全路径"] is not None else "",
              "project_name": x["单位工程名称"] if x["单位工程名称"] is not None else "",
              "item_name_wk": f'清单名称: {x["清单名称"]}' if x["清单名称"] is not None else "",
              "item_feature_wk": f'清单特征: {x["清单特征"]}' if x["清单特征"] is not None else "",
              "upper_item_name_wk": f'全路径: {x["全路径"]}' if x["全路径"] is not None else "",
              }


[dataset_custom_data_feature_dedup]
class = AccumulateDataset
input = custom_data_feature
deduplicate_by = list_key


[dataset_custom_partial]    ## GTJ 不解析分部分项
class = MapDataset
input = custom_data
expression = {"list_key": x["list_key"], "成本分部分项": x["成本分部分项"]}

[dataset_custom_partial_grouped]
class = GroupedDataset
input = custom_partial
groupby = list_key
value_key = 成本分部分项


[dataset_custom_element]
class = MapDataset
input = custom_data
expression = {"list_key": x["list_key"], "构件": x["构件"]}

[dataset_custom_element_grouped]
class = GroupedDataset
input = custom_element
groupby = list_key
value_key = 构件

[dataset_custom_material]
class = MapDataset
input = custom_data
expression = {"list_key": x["list_key"], "材料": x["材料"]}

[dataset_custom_material_grouped]
class = GroupedDataset
input = custom_material
groupby = list_key
value_key = 材料


[dataset_custom_data_mergeElement]
class = MergeIntoDataset
base_dataset = custom_data_feature_dedup
merge_datasets = custom_element_grouped
merge_type = only_replace
merge_key = list_key
merge_values = 构件
reset = False

[dataset_custom_data_mergeMaterial]
class = MergeIntoDataset
base_dataset = custom_data_mergeElement
merge_datasets = custom_material_grouped
merge_type = only_replace
merge_key = list_key
merge_values = 材料
reset = False


[dataset_custom_data_mergeAll]
class = MergeIntoDataset
base_dataset = custom_data_mergeMaterial
merge_datasets = custom_partial_grouped
merge_type = only_replace
merge_key = list_key
merge_values = 成本分部分项
reset = False

####### GTJ 客户反馈标注数据 fixed ########

[dataset_raw_custom_fixed_data]
class = ReadExcelDataset
dir = /home/shilei/corpus/cost_split/GTJ_custom_data_evaluate_20241111.xlsx
sheet_names = pred_data
header_row = 0

[dataset_raw_custom_element_fixed_data]
class = FilterDataset
input = raw_custom_fixed_data
filters = "构件预期修改" in x and x["构件预期修改"] is not None

[dataset_custom_element_fixed_data]
class = MapDataset
input = raw_custom_element_fixed_data
expression = {"list_key": str(x["清单id"]), "构件": "" if x["构件预期修改"] == "无构件" else x["构件预期修改"]}

[dataset_custom_data_mergeAll_fixed]
class = MergeIntoDataset
base_dataset = custom_data_mergeAll
merge_datasets = custom_element_fixed_data
merge_type = only_replace
merge_key = list_key
merge_values = 构件
reset = False

[dataset_custom_data_mergeAll_fixed_label]
class = MapDataset
input = custom_data_mergeAll_fixed
expression = {
    "upper_item_name_dropout": x["upper_item_name_wk"],
    "element_label": list(sorted(x["构件"].split(","))) if x["构件"] is not None else [],
    "material_label": list(sorted(x["材料"].split(","))) if x["材料"] is not None else []
    }
keep_exists = True



######################################################

[evaluator_GTJ_custom_element_extract_evaluate]
class=MultiLabelClassificationTBEvaluator
dataset = custom_data_mergeAll_fixed_label
models = GTJ_formal_element_extract_model_fixed, GTJ_formal_element_extract_model_fixed2, GTJ_formal_element_extract_model_fixed3, GTJ_formal_element_extract_model_fixed4, GTJ_formal_element_extract_model_fixed5,GTJ_formal_element_extract_model_fixed6,GTJ_formal_element_extract_model_fixed7,GTJ_formal_element_extract_model_fixed8, GTJ_formal_history_element_extract_model,GTJ_formal_history_element_extract_model2,GTJ_formal_history_element_extract_model3,GTJ_formal_history_element_extract_model4,GTJ_formal_history_element_extract_model5,GTJ_formal_history_element_extract_model6,GTJ_formal_history_element_extract_model7,GTJ_formal_history_element_extract_model8
categories = 地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙
categories_delimeter = |
label_key = element_label
save_res_path = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}/GTJ_custom_element_extract_evaluate.xlsx

[evaluator_GTJ_custom_data_element_predict]
class = SimplePredictor
datasets = custom_data_mergeAll_fixed_label
models = tjqd2, GTJ_formal_element_extract_model_fixed, GTJ_formal_element_extract_model_fixed2, GTJ_formal_element_extract_model_fixed3, GTJ_formal_element_extract_model_fixed4, GTJ_formal_element_extract_model_fixed5,GTJ_formal_element_extract_model_fixed6,GTJ_formal_element_extract_model_fixed7,GTJ_formal_element_extract_model_fixed8, GTJ_formal_history_element_extract_model,GTJ_formal_history_element_extract_model2,GTJ_formal_history_element_extract_model3,GTJ_formal_history_element_extract_model4,GTJ_formal_history_element_extract_model5,GTJ_formal_history_element_extract_model6,GTJ_formal_history_element_extract_model7,GTJ_formal_history_element_extract_model8
num_workers = 10


[dataset_GTJ_custom_data_for_export]
class = MapDataset
input = custom_data_mergeAll_fixed_label
expression = {
    "构件": ",".join(sorted(x["tjqd2_score"]["element"])) if x["tjqd2_score"] is not None and "element" in x["tjqd2_score"] else "",
    "构件预期": ",".join(sorted(x["构件"].split(","))) if x["构件"] is not None else "",
    "分部分项预期": ",".join(sorted(x["成本分部分项"].split(","))) if x["成本分部分项"] is not None else "",
    "模型构件": ",".join(sorted( [k for k, v in x["GTJ_formal_element_extract_model_fixed8_score"].items() if float(v)>=0.31] )),
    "模型history构件": ",".join(sorted( [k for k, v in x["GTJ_formal_history_element_extract_model_score"].items() if float(v)>=0.48] )),
    }
extra_dependencies = evaluator_GTJ_custom_data_element_predict
keep_exists = True

[stage_GTJ_custom_data_evaluate]
class = DatasetValStage
dataset = GTJ_custom_data_for_export
output_fields = list_key, upper_item_name, item_name, item_feature, 分部分项预期, 构件预期, 构件, 模型构件, 模型history构件
output_names = 清单id, 上级名称, 清单名称, 清单特征, 分部分项预期, 构件预期, 构件, 模型构件, 模型history构件
save_res_path = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}/stage_GTJ_custom_data_evaluate.xlsx
map_dict = {"构件":"构件预期", "模型构件": "构件预期", "模型history构件": "构件预期"}


####################### 对训练集做评估 ###########################


[evaluator_train_data_predict]
class = SimplePredictor
datasets = formal_data_train_fixed_label
models = tjqd2, GTJ_formal_element_extract_model_fixed, GTJ_formal_element_extract_model_fixed2, GTJ_formal_element_extract_model_fixed3, GTJ_formal_element_extract_model_fixed4, GTJ_formal_element_extract_model_fixed5,GTJ_formal_element_extract_model_fixed6,GTJ_formal_element_extract_model_fixed7,GTJ_formal_element_extract_model_fixed8
num_workers = 10


[dataset_train_data_for_export]
class = MapDataset
input = formal_data_train_fixed_label
expression = exec('import re; import uuid') or {
    "sample_id": uuid.uuid4().hex,
    "构件预期": ",".join(sorted(x["element_label"])) if x["element_label"] is not None else "",
    "线上构件": ",".join(sorted(x["tjqd2_score"]["element"])) if x["tjqd2_score"] is not None and "element" in x["tjqd2_score"] else "",
    "模型构件": ",".join(sorted( [k for k, v in x["GTJ_formal_element_extract_model_fixed8_score"].items() if float(v)>=0.31] )),
    }
extra_dependencies = evaluator_train_data_predict
keep_exists = True


[stage_train_data_export]
class = DatasetValStage
dataset = train_data_for_export
output_fields = list_key, upper_item_name, item_name, item_feature, 大模型1构件, 大模型2构件, 构件预期, 线上构件, 模型构件
output_names = 清单id, 上级名称, 清单名称, 清单特征, 大模型1构件, 大模型2构件, 构件预期, 线上构件, 模型构件
save_res_path = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}/stage_train_data_export.xlsx
map_dict = {"模型构件":"构件预期"}

####################### 5w+ 清单端到端构件标注获取 ###########################

; int(x["project_id"][-5:],16) % 10 < 1
[dataset_history60w_data_sample_element_data]
class = ExistsDataset
workspace = /home/shilei/fbpmx/element_p2p_cross_validation/GTJ_history60w_element_p2p_merge_20241122
reset = False

[dataset_history60w_data_sample_element_data_trans]
class = MapDataset
input = history60w_data_sample_element_data
expression = {
    "item_name_wk": f'清单名称: {x["item_name"]}' if x["item_name"] is not None else "",
    "item_feature_wk": f'清单特征: {x["item_feature"]}' if x["item_feature"] is not None else "",
    "upper_item_name_wk": f'全路径: {x["upper_item_name"]}' if x["upper_item_name"] is not None else "",
    "element_label": x["merge_label"]
    }
keep_exists = True


[dataset_history60w_train]
class = FilterDataset
input = history60w_data_sample_element_data_trans
filters = ("project_id" in x) and ( int(x["project_id"][-5:],16) % 100 >= 30 )

[dataset_history60w_test]
class = FilterDataset
input = history60w_data_sample_element_data_trans
filters = ("project_id" in x) and ( int(x["project_id"][-5:],16) % 100 < 30 )


[dataset_history60w_train_merge]
class = MergeDataset
datasets = formal_data_train_fixed_label, history60w_train


######################### 模型训练 ##############################

[model_GTJ_formal_history_extract_model]
class = MultiHeadMultiLabelClassificationModel
data = history60w_train_merge
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 2.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True

[model_GTJ_formal_history_extract_model2]
class = MultiHeadMultiLabelClassificationModel
data = history60w_train_merge
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 2.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True

[model_GTJ_formal_history_extract_model3]
class = MultiHeadMultiLabelClassificationModel
data = history60w_train_merge
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 1.0e-4
num_epochs = 200
train_ratio = 0.85
batch_size = 256
max_seq_length = 128
re_predict = True


[model_GTJ_formal_history_extract_model4]
class = MultiHeadMultiLabelClassificationModel
data = history60w_train_merge
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 1.0e-4
num_epochs = 200
train_ratio = 0.85
batch_size = 256
max_seq_length = 128
re_predict = True


[model_GTJ_formal_history_extract_model5]
class = MultiHeadMultiLabelClassificationModel
data = history60w_train_merge
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 5.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True

[model_GTJ_formal_history_extract_model6]
class = MultiHeadMultiLabelClassificationModel
data = history60w_train_merge
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 5.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True

[model_GTJ_formal_history_extract_model7]
class = MultiHeadMultiLabelClassificationModel
data = history60w_train_merge
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 5.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True


[model_GTJ_formal_history_extract_model8]
class = MultiHeadMultiLabelClassificationModel
data = history60w_train_merge
bert_base = /home/shilei/model_repository/chinese-roberta-wwm-ext_ft
text_key = item_name_wk
extra_feats = upper_item_name_wk, item_feature_wk
labels_delimeter = |
label_key = "构件": "element_label"
labels = "构件"::"地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙"
num_labels = 1
learning_rate = 5.0e-5
num_epochs = 200
train_ratio = 0.85
batch_size = 128
max_seq_length = 128
re_predict = True


[model_GTJ_formal_history_element_extract_model]
class = CalculateModel
models = GTJ_formal_history_extract_model
expression = GTJ_formal_history_extract_model["构件"]
re_predict = True

[model_GTJ_formal_history_element_extract_model2]
class = CalculateModel
models = GTJ_formal_history_extract_model2
expression = GTJ_formal_history_extract_model2["构件"]
re_predict = True


[model_GTJ_formal_history_element_extract_model3]
class = CalculateModel
models = GTJ_formal_history_extract_model3
expression = GTJ_formal_history_extract_model3["构件"]
re_predict = True


[model_GTJ_formal_history_element_extract_model4]
class = CalculateModel
models = GTJ_formal_history_extract_model4
expression = GTJ_formal_history_extract_model4["构件"]
re_predict = True


[model_GTJ_formal_history_element_extract_model5]
class = CalculateModel
models = GTJ_formal_history_extract_model5
expression = GTJ_formal_history_extract_model5["构件"]
re_predict = True

[model_GTJ_formal_history_element_extract_model6]
class = CalculateModel
models = GTJ_formal_history_extract_model6
expression = GTJ_formal_history_extract_model6["构件"]
re_predict = True


[model_GTJ_formal_history_element_extract_model7]
class = CalculateModel
models = GTJ_formal_history_extract_model7
expression = GTJ_formal_history_extract_model7["构件"]
re_predict = True


[model_GTJ_formal_history_element_extract_model8]
class = CalculateModel
models = GTJ_formal_history_extract_model8
expression = GTJ_formal_history_extract_model8["构件"]
re_predict = True


[evaluator_GTJ_formal_history_element_extract_model_evaluate]
class=MultiLabelClassificationTBEvaluator
dataset = history60w_test
models = GTJ_formal_history_element_extract_model,GTJ_formal_history_element_extract_model2,GTJ_formal_history_element_extract_model3,GTJ_formal_history_element_extract_model4,GTJ_formal_history_element_extract_model5,GTJ_formal_history_element_extract_model6,GTJ_formal_history_element_extract_model7,GTJ_formal_history_element_extract_model8
categories = 地形|道路|场地|降水井|土石方|支撑架|基坑围护|桩|砖砌挖孔桩护壁|基坑支护|地堰|花架|挡鼠板|坐凳|脚手架|竖井|车位|幕墙|屋面|消防水池|走道|地沟|采光顶|蓄水池|油池|门窗|泥浆池|止水帷幕|屋架|台阶|栏杆扶手|散水|组合栏板扶手|阳台|设备基础|挑耳|衰变池|泛水|吸水槽|地下连续墙导墙|飘窗|老虎窗|压顶|汽车坡道|防水导墙|无障碍坡道|墙|成孔芯模|空挡|板|结构缝|排水沟|基础|后浇带|洞口|梁|组合结构墙|楼梯|栏板|保温墙|挑檐板|地基|墙垛|后塞口|雨篷|暗柱|柱|斜杆|变形缝|水簸箕|隅撑|栓钉|钢柱|钢梁|钢板|钢架|钢檩条|钢拉索|钢结构连接节点|钢楼梯|钢门柱|钢窗柱|钢平台|钢墙架|设备钢支座|牛腿|桩尖|爬梯|组合结构柱|组合结构梁|组合结构楼板|车棚|楼地面|踢脚线|装饰成品构件|固定脚套|墙面|钢板墙板|墙裙|天棚|装饰线条|护角|地台|建筑地坪|场地地形|土方|石方|边桩|钢节点|支护桩|支撑梁|钢格构柱|钢支撑|桩间挂网|护坡|斜支撑|地下连续墙|电梯井|楼梯井|车挡|屋面变形缝|女儿墙|排水板|反檐|垃圾道、通风道、烟道|走道板|门|卷帘动力装置|窗|窗台板|门联窗|门套、窗套|门框|栏杆|扶手|预制阳台|砖胎膜|预制飘窗|结构墙|挡土墙|人防门框墙|钢墙|隔墙|砌体墙|挡水墙|预制墙|现浇板|沟盖板、井盖板、井圈|预制板|构造板|凸窗侧板|钢板楼板|板缝|褥垫层|基础梁|集水坑|垫层|筏板基础|条形基础|独立基础|桩承台|桩基|板洞|墙洞|壁龛|门窗洞口|检修口|灯孔|结构梁|连梁|过梁|圈梁|构造梁|梁加腋|暗梁|预制梁|预制过梁|直形梯段|螺旋梯段|预制楼梯|天然地基|换填地基|预制雨篷|结构柱|构造柱|柱墩|柱帽|柱脚|砌体柱|预制柱|实腹钢梁|翼缘板|钢屋架|钢网架|钢桁架|钢托架|楼地面变形缝|过门石|固定件|内墙面|外墙面|墙面变形缝|柱面|吊顶|梁面|余方|钢桩|土钉墙|锚杆(锚索)|垃圾道|通风道|烟道|沟盖板|井盖板|井圈|电梯坑|桩头|桩端|门洞口|窗洞口|抱框柱|内墙裙|外墙裙|GFRP土钉|截水沟|电缆沟|围墙
categories_delimeter = |
label_key = element_label
save_res_path = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}/GTJ_formal_history_element_extract_model_evaluate.xlsx


######################### 模型评估 ##############################


[evaluator_history60w_sample_predict]
class = SimplePredictor
datasets = history60w_test, history60w_train
models = tjqd2, GTJ_formal_element_extract_model_fixed, GTJ_formal_element_extract_model_fixed2, GTJ_formal_element_extract_model_fixed3, GTJ_formal_element_extract_model_fixed4, GTJ_formal_element_extract_model_fixed5,GTJ_formal_element_extract_model_fixed6,GTJ_formal_element_extract_model_fixed7,GTJ_formal_element_extract_model_fixed8, GTJ_formal_history_element_extract_model,GTJ_formal_history_element_extract_model2,GTJ_formal_history_element_extract_model3,GTJ_formal_history_element_extract_model4,GTJ_formal_history_element_extract_model5,GTJ_formal_history_element_extract_model6,GTJ_formal_history_element_extract_model7,GTJ_formal_history_element_extract_model8
num_workers = 1


[dataset_history60w_test_data_for_export]
class = MapDataset
input = history60w_test
expression = exec('import re; import uuid') or {
    "构件预期": ",".join(sorted(x["element_label"])) if x["element_label"] is not None else "",
    "线上构件": ",".join(sorted(x["tjqd2_score"]["element"])) if x["tjqd2_score"] is not None and "element" in x["tjqd2_score"] else "",
    "模型构件": ",".join(sorted( [k for k, v in x["GTJ_formal_element_extract_model_fixed8_score"].items() if float(v)>=0.31] )),
    "模型history构件": ",".join(sorted( [k for k, v in x["GTJ_formal_history_element_extract_model_score"].items() if float(v)>=0.48] )),
    }
extra_dependencies = evaluator_history60w_sample_predict
keep_exists = True


[stage_history60w_test_data_export]
class = DatasetValStage
dataset = history60w_test_data_for_export
output_fields = list_key, upper_item_name, item_name, item_feature, 构件预期, 线上构件, 模型构件, 模型history构件
output_names = 清单id, 上级名称, 清单名称, 清单特征, 构件预期, 线上构件, 模型构件, 模型history构件
save_res_path = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}/stage_history60w_test_data_export.xlsx
map_dict = {"模型构件":"构件预期", "线上构件": "构件预期", "模型history构件": "构件预期"}


######################### 5w+ 训练集评估 ##############################

[dataset_history60w_train_data_for_export]
class = MapDataset
input = history60w_train
expression = exec('import re; import uuid') or {
    "project_id": x["project_id"],
    "list_key": x["list_key"],
    "upper_item_name": x["upper_item_name"],
    "item_name": x["item_name"],
    "item_feature": x["item_feature"],
    "构件预期": ",".join(sorted(x["element_label"])) if x["element_label"] is not None else "",
    "线上构件": ",".join(sorted(x["tjqd2_score"]["element"])) if x["tjqd2_score"] is not None and "element" in x["tjqd2_score"] else "",
    "模型构件": ",".join(sorted( [k for k, v in x["GTJ_formal_element_extract_model_fixed8_score"].items() if float(v)>=0.31] )),
    "模型history构件": ",".join(sorted( [k for k, v in x["GTJ_formal_history_element_extract_model_score"].items() if float(v)>=0.48] )),
    }
extra_dependencies = evaluator_history60w_sample_predict
keep_exists = False


[dataset_history60w_train_data_for_export1]
class = FilterDataset
input = history60w_train_data_for_export
filters = ("project_id" in x) and ( int(x["project_id"][-5:],16) % 1000 < 300 )

[dataset_history60w_train_data_for_export2]
class = FilterDataset
input = history60w_train_data_for_export
filters = ("project_id" in x) and ( int(x["project_id"][-5:],16) % 1000 >= 300 and int(x["project_id"][-5:],16) % 1000 < 600 )

[dataset_history60w_train_data_for_export3]
class = FilterDataset
input = history60w_train_data_for_export
filters = ("project_id" in x) and ( int(x["project_id"][-5:],16) % 1000 >= 600 )

[stage_history60w_train_data_export_1]
class = DatasetValStage
dataset = history60w_train_data_for_export1
output_fields = list_key, upper_item_name, item_name, item_feature, 构件预期, 线上构件, 模型构件, 模型history构件
output_names = 清单id, 上级名称, 清单名称, 清单特征, 构件预期, 线上构件, 模型构件, 模型history构件
save_res_path = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}/stage_history60w_train_data_export_1.xlsx
map_dict = {"模型构件":"构件预期", "线上构件": "构件预期", "模型history构件": "构件预期"}

[stage_history60w_train_data_export_2]
class = DatasetValStage
dataset = history60w_train_data_for_export2
output_fields = list_key, upper_item_name, item_name, item_feature, 构件预期, 线上构件, 模型构件, 模型history构件
output_names = 清单id, 上级名称, 清单名称, 清单特征, 构件预期, 线上构件, 模型构件, 模型history构件
save_res_path = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}/stage_history60w_train_data_export_2.xlsx
map_dict = {"模型构件":"构件预期", "线上构件": "构件预期", "模型history构件": "构件预期"}

[stage_history60w_train_data_export_3]
class = DatasetValStage
dataset = history60w_train_data_for_export3
output_fields = list_key, upper_item_name, item_name, item_feature, 构件预期, 线上构件, 模型构件, 模型history构件
output_names = 清单id, 上级名称, 清单名称, 清单特征, 构件预期, 线上构件, 模型构件, 模型history构件
save_res_path = /home/shilei/fbpmx/list_extract/list_extract_analysis_for_gtj_fixlabel_element_${date}/stage_history60w_train_data_export_3.xlsx
map_dict = {"模型构件":"构件预期", "线上构件": "构件预期", "模型history构件": "构件预期"}